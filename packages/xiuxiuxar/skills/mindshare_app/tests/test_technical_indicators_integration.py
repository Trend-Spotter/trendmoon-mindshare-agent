"""Integration tests for technical indicators calculation."""

from pathlib import Path

import pytest
from aea.test_tools.test_skill import BaseSkillTestCase

from packages.xiuxiuxar.skills.mindshare_app.behaviours.analysis import AnalysisRound


MOVING_AVERAGE_LENGTH = 20


@pytest.mark.integration
@pytest.mark.skipif(not MOVING_AVERAGE_LENGTH, reason="Moving average length not found in environment variables")
class TestTechnicalIndicatorsIntegration(BaseSkillTestCase):
    """Test technical indicators calculation with real data processing."""

    path_to_skill = Path(__file__).parent.parent

    def setup(self):
        """Setup the test class."""
        super().setup()

        self.analysis_round = AnalysisRound(
            name="analysis_round",
            skill_context=self.skill.skill_context,
        )
        self.logger = self.skill.skill_context.logger

        # Sample valid OHLCV data for testing
        self.valid_ohlcv_data = [
            [1751616000000, 1.64, 1.65, 1.59, 1.59, 219894451.64363047],
            [1751630400000, 1.59, 1.62, 1.58, 1.6, 208123066.6568845],
            [1751644800000, 1.6, 1.6, 1.54, 1.54, 175857467.37977162],
            [1751659200000, 1.54, 1.54, 1.52, 1.53, 180237133.84650144],
            [1751673600000, 1.53, 1.57, 1.53, 1.55, 185302989.87230372],
            [1751688000000, 1.55, 1.58, 1.55, 1.58, 176765128.75694305],
            [1751702400000, 1.57, 1.62, 1.56, 1.6, 178625892.5471621],
            [1751716800000, 1.6, 1.61, 1.57, 1.57, 173528994.32771483],
            [1751731200000, 1.56, 1.56, 1.54, 1.55, 149957928.63779587],
            [1751745600000, 1.55, 1.55, 1.52, 1.54, 139260075.237165],
            [1751760000000, 1.54, 1.55, 1.53, 1.54, 125822513.69330421],
            [1751774400000, 1.54, 1.55, 1.53, 1.53, 119990222.89552742],
            [1751788800000, 1.53, 1.55, 1.53, 1.54, 106935961.49339555],
            [1751803200000, 1.53, 1.54, 1.52, 1.54, 100313472.10319571],
            [1751817600000, 1.54, 1.58, 1.54, 1.54, 121594433.00103235],
            [1751832000000, 1.55, 1.56, 1.54, 1.54, 119316939.1267934],
            [1751846400000, 1.54, 1.59, 1.54, 1.55, 132250373.12547025],
            [1751860800000, 1.55, 1.59, 1.54, 1.57, 142424679.53252816],
            [1751875200000, 1.57, 1.58, 1.54, 1.55, 142995525.98304713],
            [1751889600000, 1.56, 1.56, 1.53, 1.54, 142959914.62183183],
            [1751904000000, 1.54, 1.54, 1.5, 1.5, 130062139.95421274],
            [1751918400000, 1.5, 1.5, 1.47, 1.49, 131776971.24743427],
            [1751932800000, 1.49, 1.5, 1.47, 1.5, 128841802.27018064],
            [1751947200000, 1.5, 1.51, 1.47, 1.47, 125677966.89452535],
            [1751961600000, 1.47, 1.48, 1.46, 1.47, 128388293.10935995],
            [1751976000000, 1.47, 1.48, 1.46, 1.47, 127820526.83996488],
            [1751990400000, 1.47, 1.47, 1.44, 1.44, 129801547.25243889],
            [1752004800000, 1.44, 1.48, 1.43, 1.47, 132816690.5073445],
            [1752019200000, 1.47, 1.48, 1.46, 1.47, 127582654.55242254],
            [1752033600000, 1.47, 1.47, 1.44, 1.45, 120050864.93926264],
            [1752048000000, 1.45, 1.48, 1.45, 1.46, 118295146.43950695],
            [1752062400000, 1.46, 1.47, 1.46, 1.47, 115710301.87980115],
            [1752076800000, 1.47, 1.5, 1.46, 1.46, 122507392.70804039],
            [1752091200000, 1.46, 1.56, 1.46, 1.56, 150436159.4375722],
            [1752105600000, 1.55, 1.57, 1.52, 1.56, 195006330.0441966],
            [1752120000000, 1.56, 1.6, 1.56, 1.58, 223350341.59812367],
            [1752134400000, 1.59, 1.66, 1.58, 1.63, 262007047.90445742],
            [1752148800000, 1.63, 1.65, 1.6, 1.62, 283149647.90133107],
            [1752163200000, 1.62, 1.62, 1.59, 1.59, 278528969.41612065],
            [1752177600000, 1.59, 1.71, 1.59, 1.66, 318821841.3296485],
            [1752192000000, 1.66, 1.78, 1.66, 1.76, 355188202.3946541],
            [1752206400000, 1.76, 1.81, 1.73, 1.81, 304828044.3384728],
            [1752220800000, 1.81, 1.85, 1.78, 1.79, 354724919.6883322],
            [1752235200000, 1.78, 1.85, 1.78, 1.83, 343917011.19131905],
            [1752249600000, 1.84, 1.87, 1.81, 1.81, 450224536.6083719],
            [1752264000000, 1.77, 1.8, 1.77, 1.79, 413172179.5227624],
            [1752278400000, 1.79, 1.79, 1.68, 1.72, 332463367.8960815],
            [1752292800000, 1.72, 1.76, 1.69, 1.75, 307996507.14577466],
            [1752307200000, 1.76, 1.76, 1.71, 1.74, 286793718.4910652],
            [1752321600000, 1.75, 1.78, 1.75, 1.75, 302957563.5280698],
            [1752336000000, 1.75, 1.75, 1.64, 1.65, 268216053.2424474],
            [1752350400000, 1.65, 1.72, 1.65, 1.72, 214391176.00987053],
            [1752364800000, 1.72, 1.72, 1.7, 1.71, 206862151.07900476],
            [1752379200000, 1.71, 1.72, 1.7, 1.71, 193170402.68789524],
            [1752393600000, 1.71, 1.72, 1.7, 1.72, 185296474.4142713],
            [1752408000000, 1.72, 1.74, 1.7, 1.74, 186125826.21417505],
            [1752422400000, 1.75, 1.78, 1.72, 1.72, 183178942.82318828],
            [1752436800000, 1.73, 1.75, 1.71, 1.74, 165843614.9955242],
            [1752451200000, 1.74, 1.75, 1.69, 1.71, 204938672.29332802],
            [1752465600000, 1.71, 1.81, 1.7, 1.81, 245674217.91579196],
            [1752480000000, 1.81, 1.83, 1.77, 1.8, 304742030.42771024],
            [1752494400000, 1.79, 1.81, 1.76, 1.8, 323182379.1524809],
            [1752508800000, 1.79, 1.81, 1.71, 1.71, 318614606.09982425],
            [1752523200000, 1.71, 1.72, 1.68, 1.68, 279525783.17389137],
            [1752537600000, 1.68, 1.7, 1.66, 1.69, 318377598.5143363],
            [1752552000000, 1.69, 1.69, 1.6, 1.61, 291378690.63696796],
            [1752566400000, 1.61, 1.64, 1.6, 1.61, 263069812.2102308],
            [1752580800000, 1.61, 1.61, 1.59, 1.6, 245375729.78306308],
            [1752595200000, 1.61, 1.66, 1.59, 1.62, 270214661.5493118],
            [1752609600000, 1.62, 1.67, 1.6, 1.6, 283840183.2625638],
            [1752624000000, 1.6, 1.68, 1.6, 1.68, 246593770.41869545],
            [1752638400000, 1.68, 1.7, 1.64, 1.64, 281132071.4061318],
            [1752652800000, 1.64, 1.69, 1.63, 1.69, 235287886.33095002],
            [1752667200000, 1.69, 1.69, 1.67, 1.68, 237377431.42263013],
            [1752681600000, 1.68, 1.73, 1.68, 1.69, 266139708.7548708],
            [1752696000000, 1.69, 1.83, 1.69, 1.79, 253071263.3651757],
            [1752710400000, 1.79, 1.84, 1.77, 1.78, 282773557.6824618],
            [1752724800000, 1.78, 1.82, 1.71, 1.72, 343167562.2633318],
            [1752739200000, 1.72, 1.82, 1.72, 1.82, 372365929.79291904],
            [1752753600000, 1.82, 1.89, 1.82, 1.84, 490551196.89620435],
            [1752768000000, 1.84, 1.86, 1.81, 1.83, 448822434.0820368],
            [1752782400000, 1.83, 1.83, 1.79, 1.79, 427093196.31309897],
            [1752796800000, 1.78, 1.84, 1.76, 1.82, 386102084.0135523],
            [1752811200000, 1.81, 1.87, 1.79, 1.86, 401195704.749859],
            [1752825600000, 1.86, 1.92, 1.85, 1.88, 419399327.58988744],
            [1752840000000, 1.87, 1.88, 1.84, 1.84, 343097743.15177023],
            [1752854400000, 1.84, 1.89, 1.75, 1.76, 410181088.91096115],
            [1752868800000, 1.76, 1.78, 1.73, 1.73, 384798456.3930166],
            [1752883200000, 1.73, 1.74, 1.69, 1.74, 303552082.30767804],
            [1752897600000, 1.74, 1.75, 1.7, 1.75, 311500525.75840175],
            [1752912000000, 1.75, 1.76, 1.74, 1.74, 239915744.93455845],
            [1752926400000, 1.74, 1.78, 1.72, 1.77, 239257402.86450297],
            [1752940800000, 1.76, 1.77, 1.72, 1.74, 176135042.2449732],
            [1752955200000, 1.74, 1.77, 1.73, 1.77, 131427262.58581974],
            [1752969600000, 1.77, 1.79, 1.75, 1.77, 134162940.21944273],
            [1752984000000, 1.77, 1.79, 1.76, 1.78, 114673491.38193722],
            [1752998400000, 1.78, 1.79, 1.76, 1.78, 129965673.15090941],
            [1753012800000, 1.78, 1.81, 1.78, 1.81, 133487328.56004307],
            [1753027200000, 1.81, 1.85, 1.8, 1.85, 131654229.898326],
            [1753041600000, 1.86, 1.88, 1.82, 1.84, 189999258.35649756],
            [1753056000000, 1.84, 1.85, 1.8, 1.83, 226463651.96384037],
            [1753070400000, 1.83, 1.87, 1.78, 1.87, 211077009.05645347],
            [1753084800000, 1.88, 1.93, 1.87, 1.91, 215833059.8310774],
            [1753099200000, 1.91, 1.92, 1.88, 1.9, 271594207.1763867],
            [1753113600000, 1.89, 1.95, 1.88, 1.9, 340613148.00190675],
            [1753128000000, 1.9, 1.9, 1.84, 1.84, 337981926.88446915],
            [1753142400000, 1.84, 1.93, 1.84, 1.92, 130179432.73941442],
            [1753156800000, 1.92, 1.95, 1.85, 1.87, 339026730.5790883],
            [1753171200000, 1.87, 1.89, 1.82, 1.83, 342465352.513729],
            [1753185600000, 1.83, 1.84, 1.79, 1.84, 357461647.8274968],
            [1753200000000, 1.84, 1.89, 1.83, 1.87, 348166537.56143457],
            [1753214400000, 1.86, 1.89, 1.83, 1.86, 377940299.05936193],
            [1753228800000, 1.85, 1.94, 1.85, 1.93, 389365172.5811948],
            [1753243200000, 1.93, 1.93, 1.88, 1.88, 346536240.27974916],
            [1753257600000, 1.88, 1.92, 1.88, 1.88, 306393349.3554363],
            [1753272000000, 1.87, 1.88, 1.82, 1.83, 252684855.8705001],
            [1753286400000, 1.83, 1.83, 1.74, 1.75, 281098187.71663606],
            [1753300800000, 1.75, 1.75, 1.7, 1.73, 275561082.5928826],
            [1753315200000, 1.72, 1.73, 1.65, 1.71, 234368975.2035255],
            [1753329600000, 1.71, 1.72, 1.68, 1.68, 275711650.9920359],
            [1753344000000, 1.68, 1.68, 1.53, 1.57, 316926777.827315],
            [1753358400000, 1.57, 1.6, 1.55, 1.6, 330576685.0250787],
            [1753372800000, 1.6, 1.64, 1.56, 1.61, 307044236.2155548],
            [1753387200000, 1.6, 1.6, 1.55, 1.58, 308305684.7977087],
            [1753401600000, 1.57, 1.59, 1.54, 1.54, 287972868.1195403],
            [1753416000000, 1.53, 1.55, 1.51, 1.52, 309116422.2254981],
            [1753430400000, 1.52, 1.53, 1.5, 1.5, 279070874.53254807],
            [1753444800000, 1.51, 1.57, 1.51, 1.56, 256045748.68755478],
            [1753459200000, 1.56, 1.56, 1.48, 1.49, 251770923.70092294],
            [1753473600000, 1.5, 1.52, 1.49, 1.52, 234011742.7528837],
            [1753488000000, 1.52, 1.57, 1.52, 1.57, 189458104.435704],
            [1753502400000, 1.57, 1.58, 1.56, 1.58, 159977179.43457586],
            [1753516800000, 1.58, 1.58, 1.57, 1.58, 134852852.42397606],
            [1753531200000, 1.58, 1.6, 1.58, 1.59, 121464476.61530682],
            [1753545600000, 1.59, 1.6, 1.57, 1.59, 97955527.16149905],
            [1753560000000, 1.59, 1.59, 1.57, 1.59, 107668993.79693803],
            [1753574400000, 1.59, 1.59, 1.57, 1.57, 85033831.82976198],
            [1753588800000, 1.57, 1.59, 1.57, 1.58, 80539188.06431161],
            [1753603200000, 1.58, 1.59, 1.58, 1.58, 93476576.30827336],
            [1753617600000, 1.58, 1.6, 1.57, 1.59, 74211383.89461067],
            [1753632000000, 1.59, 1.59, 1.57, 1.58, 84485266.1358479],
            [1753646400000, 1.58, 1.62, 1.58, 1.58, 89748840.12399249],
            [1753660800000, 1.58, 1.61, 1.57, 1.6, 107159354.87099716],
            [1753675200000, 1.6, 1.61, 1.56, 1.59, 105261366.98719612],
            [1753689600000, 1.59, 1.61, 1.58, 1.59, 140482041.0015028],
            [1753704000000, 1.59, 1.6, 1.57, 1.58, 144062830.17198908],
            [1753718400000, 1.57, 1.58, 1.5, 1.5, 144713409.99985662],
            [1753732800000, 1.49, 1.49, 1.46, 1.46, 176731197.1318259],
            [1753747200000, 1.46, 1.46, 1.43, 1.44, 186200091.56547225],
            [1753761600000, 1.45, 1.47, 1.45, 1.46, 187659913.25814012],
            [1753776000000, 1.46, 1.49, 1.45, 1.49, 181867824.51680297],
            [1753790400000, 1.49, 1.49, 1.45, 1.45, 181460084.12963006],
            [1753804800000, 1.45, 1.47, 1.38, 1.39, 188351341.0863074],
            [1753819200000, 1.39, 1.39, 1.36, 1.36, 186467250.5919222],
            [1753833600000, 1.36, 1.38, 1.34, 1.38, 194063651.71327758],
            [1753848000000, 1.38, 1.38, 1.36, 1.37, 181998757.92277712],
            [1753862400000, 1.37, 1.38, 1.36, 1.37, 179505132.01860145],
            [1753876800000, 1.37, 1.38, 1.32, 1.32, 182258990.54379588],
            [1753891200000, 1.32, 1.35, 1.31, 1.33, 167189986.84950364],
            [1753905600000, 1.33, 1.35, 1.28, 1.33, 190693571.80695674],
            [1753920000000, 1.34, 1.34, 1.31, 1.34, 180703434.27041578],
            [1753934400000, 1.34, 1.37, 1.34, 1.37, 158839587.39535812],
            [1753948800000, 1.37, 1.38, 1.37, 1.38, 159157609.22832456],
            [1753963200000, 1.38, 1.38, 1.37, 1.37, 160169261.42979866],
            [1753977600000, 1.37, 1.37, 1.31, 1.32, 150730304.86747676],
            [1753992000000, 1.32, 1.35, 1.3, 1.3, 117021669.14032546],
            [1754006400000, 1.3, 1.3, 1.25, 1.25, 117279707.82042058],
            [1754020800000, 1.25, 1.25, 1.22, 1.24, 149189261.46285856],
            [1754035200000, 1.24, 1.24, 1.22, 1.22, 151959552.3628442],
            [1754049600000, 1.22, 1.22, 1.2, 1.22, 168694274.6500017],
            [1754064000000, 1.22, 1.24, 1.2, 1.23, 178163590.2715251],
            [1754078400000, 1.23, 1.24, 1.2, 1.23, 180698078.45508504],
            [1754092800000, 1.23, 1.24, 1.19, 1.22, 193801377.27757213],
            [1754107200000, 1.22, 1.22, 1.21, 1.22, 161903157.8851922],
            [1754121600000, 1.22, 1.22, 1.18, 1.21, 162901569.305603],
            [1754136000000, 1.21, 1.21, 1.18, 1.19, 147103762.59802812],
            [1754150400000, 1.19, 1.19, 1.17, 1.17, 127256578.39510624],
            [1754164800000, 1.17, 1.18, 1.14, 1.15, 137473161.9916814],
            [1754179200000, 1.15, 1.16, 1.14, 1.15, 116078656.71443428],
            [1754193600000, 1.15, 1.22, 1.15, 1.21, 121545160.79777722],
        ]

        self.ma_length = 20

    def test_get_technical_data_integration(self):
        """Test _get_technical_data with real OHLCV data and technical indicator calculations."""
        result = self.analysis_round._get_technical_data(self.valid_ohlcv_data)  # noqa: SLF001

        # Assert the result is a list of tuples (indicator_name, value)
        assert isinstance(result, list)
        assert len(result) > 0

        # Check that we get expected technical indicators
        indicator_names = [item[0] for item in result]
        expected_indicators = ["SMA", "EMA", "RSI", "MACD", "ADX", "BB", "OBV", "CMF"]

        for indicator in expected_indicators:
            assert indicator in indicator_names, f"Expected indicator {indicator} not found in result"

        # Verify each result item is a tuple with proper format
        for item in result:
            assert isinstance(item, tuple)
            assert len(item) == 2
            indicator_name, indicator_value = item
            assert isinstance(indicator_name, str)
            # Value can be a number or dict (for complex indicators like MACD, BB)
            assert isinstance(indicator_value, int | float | dict)
